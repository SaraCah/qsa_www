<%= setup_context(:title => I18n.t("reading_room_requests._plural")) %>

<%
  def badge_class_for_status(status)
    if status.starts_with?('CANCELLED') || status.starts_with?('REJECTED')
      'label-danger'
    elsif status == 'AWAITING_AGENCY_APPROVAL'
      'label-warning'
    elsif status == 'PENDING'
      'label-default'
    elsif status == 'COMPLETE'
      'label-success'
    elsif ['READY_FOR_RETRIEVAL', 'WITH_RESEARCHER', 'RETURNED_BY_RESEARCHER'].include?(status) 
      'label-primary'
    else
      'label-info'
    end
  end
%>


<div class="row">
  <div class="col-md-3">
    <div class="sidebar">
      <%= render_aspace_partial :partial => "search/filter" %>

      <% if @search_data.results? && !Array(@search_data[:criteria]['filter_term[]']).find {|term| JSON.parse(term).keys[0] == 'date_required'} %>
        <h3>Date required</h3>
        <ul>
          <li><%= link_to("Today", build_search_params({}).merge("filter_term[]" => {"date_required" => 1}.to_json)) %></li>
          <li><%= link_to("Within 3 days", build_search_params({}).merge("filter_term[]" => {"date_required" => 3}.to_json)) %></li>
          <li><%= link_to("Within 7 days", build_search_params({}).merge("filter_term[]" => {"date_required" => 7}.to_json)) %></li>
          <li><%= link_to("Within 14 days", build_search_params({}).merge("filter_term[]" => {"date_required" => 14}.to_json)) %></li>
        </ul>
      <% end %>


    </div>
  </div>
  <div class="col-md-9">
    <div class="record-pane">
      <%= link_to_help :topic => "search" %>

      <h2><%= I18n.t("reading_room_requests._plural") %></h2>

      <%= render_aspace_partial :partial => "shared/flash_messages" %>

      <% if @search_data.results? %>
        <%= render_aspace_partial :partial => "shared/pagination_summary" %>

        <table id="tabledSearchResults" class="table table-striped table-bordered table-condensed table-hover table-sortable table-search-results">
          <thead>
          <tr>
            <th style="width:100px"><%= I18n.t("as_runcorn.qsa_id") %></th>
            <th><%= I18n.t("reading_room_requests.requested_item") %></th>
            <th><%= I18n.t("reading_room_requests.researcher_name") %></th>
            <th><%= I18n.t("reading_room_requests.status") %></th>
            <th><%= I18n.t("reading_room_requests.date_required") %></th>
            <th class="col actions"><!-- actions --></th>
          </tr>
          </thead>
          <tbody>
          <% @search_data['results'].each do |result|
            deleted = (params.has_key?("deleted_uri") and Array(params["deleted_uri"]).include?(result["id"])) || false
          %>
            <% parsed = ASUtils.json_parse(result['json']) %>
            <% request_id = JSONModel(:reading_room_request).id_for(result['uri']) %>
            <tr class="<%= "deleted" if deleted %>">
              <td><%= QSAIdHelper.id(parsed.fetch('qsa_id_prefixed')) %></td>
              <td>
                <% requested_item = parsed.fetch('requested_item', {}).fetch('_resolved', {}) %>
                <%= ('<div class="token-list">' +
                        render_token(:object => requested_item,
                                     :label => ("%s: %s" % [requested_item['qsa_id_prefixed'], requested_item['title']]).html_safe,
                                     :type => requested_item['jsonmodel_type'],
                                     :uri => requested_item["uri"],
                                     :placement => "top",
                                     :inside_linker_browse => true) +
                        '</div>').html_safe %>

                <% unless requested_item.fetch('calculated_availability') == 'available' %>
                  <div class="clearfix"></div>
                  <div class="label label-danger">
                    <%= I18n.t('reading_room_requests.availability.' + requested_item.fetch('calculated_availability')) %>
                  </div>
                <% end %>
              </td>
              <td>
                <% user = parsed.fetch('requesting_user')
                   names = [user.fetch('first_name', nil), user.fetch('last_name', nil)].compact.join(" ") %>
                <% if names.empty? %>
                  <%= user.fetch('email') %>
                <% else %>
                   <%= "%s <%s>" % [names, user.fetch('email')] %>  
                <% end %>
              </td>
              <td class="rrr-status">
                <div><%= ("<div class='label #{badge_class_for_status(parsed.fetch('status'))}'>" + I18n.t('reading_room_requests.statuses.' + parsed.fetch('status').downcase).upcase + '</div>').html_safe %></div>
              </td>
              <td>
                <% date = parsed.fetch('date_required', '') %>
                <% unless date.to_s.empty? %>
                  <%= Time.at(Integer(date) / 1000).to_date.iso8601 %>
                <% end %>
              </td>
              <td class="table-record-actions">
                <%= link_to "<span class='fa fa-download' aria-hidden='true'></span> Slip".html_safe, {:controller => :reading_room_requests, :action => :picking_slip, :id => request_id}, :title => "Download picking slip", :target => '_blank', :class => 'btn btn-default btn-xs' %>
                <div class="rrr-status-actions">
                  <% if parsed.fetch('status') == 'AWAITING_AGENCY_APPROVAL' %>
                    <button class="btn btn-success btn-xs" data-id="<%= request_id %>" data-status="APPROVED_BY_AGENCY">Approved by Agency</button>
                    <button class="btn btn-danger btn-xs" data-id="<%= request_id %>" data-status="REJECTED_BY_AGENCY">Rejected by Agency</button>
                    <button class="btn btn-danger btn-xs" data-id="<%= request_id %>" data-status="CANCELLED_BY_QSA">Cancelled by QSA</button>
                    <button class="btn btn-danger btn-xs"  data-id="<%= request_id %>"data-status="CANCELLED_BY_RESEARCHER">Cancelled by Researcher</button>
                  <% elsif parsed.fetch('status') == 'PENDING' %>
                    <button class="btn btn-primary btn-xs" data-id="<%= request_id %>" data-status="IN_RETRIEVAL">In Retrieval</button>
                    <button class="btn btn-danger btn-xs" data-id="<%= request_id %>" data-status="CANCELLED_BY_QSA">Cancelled by QSA</button>
                    <button class="btn btn-danger btn-xs" data-id="<%= request_id %>" data-status="CANCELLED_BY_RESEARCHER">Cancelled by Researcher</button>
                  <% elsif parsed.fetch('status') == 'IN_RETRIEVAL' %>
                    <button class="btn btn-primary btn-xs" data-id="<%= request_id %>" data-status="READY_FOR_RETRIEVAL">Ready for Retrieval</button>
                    <button class="btn btn-danger btn-xs" data-id="<%= request_id %>" data-status="CANCELLED_BY_QSA">Cancelled by QSA</button>
                    <button class="btn btn-danger btn-xs" data-id="<%= request_id %>" data-status="CANCELLED_BY_RESEARCHER">Cancelled by Researcher</button>
                  <% elsif parsed.fetch('status') == 'READY_FOR_RETRIEVAL' %>
                    <button class="btn btn-primary btn-xs" data-id="<%= request_id %>" data-status="WITH_RESEARCHER">Retrieved by Researcher</button>
                    <button class="btn btn-danger btn-xs" data-id="<%= request_id %>" data-status="CANCELLED_BY_QSA">Cancelled by QSA</button>
                    <button class="btn btn-danger btn-xs" data-id="<%= request_id %>" data-status="CANCELLED_BY_RESEARCHER">Cancelled by Researcher</button>
                  <% elsif parsed.fetch('status') == 'WITH_RESEARCHER' %>
                    <button class="btn btn-primary btn-xs" data-id="<%= request_id %>" data-status="RETURNED_BY_RESEARCHER">Returned by Researcher</button>
                  <% elsif parsed.fetch('status') == 'RETURNED_BY_RESEARCHER' %>
                    <button class="btn btn-success btn-xs" data-id="<%= request_id %>" data-status="COMPLETE">Item Returned to Home Location</button>
                  <% end %>
                </div>
              </td>
            </tr>
          <% end %>
          </tbody>
        </table>
        <%= render_aspace_partial :partial => "shared/pagination" %>
      <% else %>
        <p class="alert alert-info">
          <%= I18n.t("search_results.no_results") %>
        </p>
      <% end %>

    </div>
  </div>
</div>

<script>
  $('.rrr-status-actions button').on('click', function(e) {
    var data = $(e.target).data();
    $.ajax({
      url: APP_PATH + 'reading_room_requests/' + data.id + '/set_status',
      method: 'POST',
      data: {
        'status': data.status
      },
      success: function() {
        location.reload();
      }
    })
  });
</script>
<style>
  .rrr-status-actions button {
    display: block;
    margin-top: 5px;
  }
</style>
